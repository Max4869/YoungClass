<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <title>ğŸ è´ªåƒè›‡å°æ¸¸æˆ</title>
    <style>
      body {
        font-family: "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #74ebd5, #9face6);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
      }
      .game-container {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        width: 520px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        text-align: center;
      }
      h1 {
        margin: 0 0 10px;
      }
      .info-panel {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        font-weight: bold;
      }
      canvas {
        background: #f5f5f5;
        border: 2px solid #333;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .controls,
      .customize,
      .modes,
      .leaderboard {
        margin: 10px 0;
        font-size: 14px;
      }
      button,
      select {
        margin: 3px;
        padding: 6px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }
      button {
        background: #4caf50;
        color: white;
      }
      button:hover {
        background: #45a049;
      }
      .leaderboard ul {
        list-style: none;
        padding: 0;
        text-align: left;
      }
      .leaderboard li {
        margin: 3px 0;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>ğŸ è´ªåƒè›‡å°æ¸¸æˆ</h1>
      <div class="info-panel">
        <div>åˆ†æ•°ï¼š<span id="score">0</span></div>
        <div>æœ€é«˜åˆ†ï¼š<span id="highscore">0</span></div>
      </div>
      <canvas id="gameCanvas" width="400" height="400"></canvas>

      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="controls">
        <button id="startBtn">å¼€å§‹</button>
        <button id="pauseBtn">æš‚åœ</button>
        <button id="resetBtn">é‡æ¥</button>
        <label
          >éš¾åº¦ï¼š
          <select id="difficulty">
            <option value="200">ç®€å•</option>
            <option value="150" selected>ä¸­ç­‰</option>
            <option value="100">å›°éš¾</option>
            <option value="70">åœ°ç‹±</option>
          </select>
        </label>
        <br />
        <label
          >é€Ÿåº¦ï¼š<input
            type="range"
            id="speedRange"
            min="50"
            max="300"
            step="10"
            value="150"
        /></label>
      </div>

      <!-- ä¸ªæ€§åŒ–è®¾ç½® -->
      <div class="customize">
        <label
          >èƒŒæ™¯ï¼š
          <select id="theme">
            <option value="plain">çº¯è‰²</option>
            <option value="gradient" selected>æ¸å˜</option>
            <option value="grass">è‰åœ°</option>
            <option value="pixel">åƒç´ æ ¼å­</option>
          </select>
        </label>
        <label
          >è›‡é¢œè‰²ï¼š<input type="color" id="snakeColor" value="#4caf50"
        /></label>
        <label
          >é£Ÿç‰©ï¼š
          <select id="foodStyle">
            <option value="square">æ–¹å—</option>
            <option value="apple">ğŸè‹¹æœ</option>
            <option value="cherry">ğŸ’æ¨±æ¡ƒ</option>
            <option value="cookie">ğŸªé¥¼å¹²</option>
          </select>
        </label>
        <br />
        <label><input type="checkbox" id="bgmToggle" checked /> èƒŒæ™¯éŸ³ä¹</label>
        <label><input type="checkbox" id="sfxToggle" checked /> éŸ³æ•ˆ</label>
      </div>

      <!-- æ¨¡å¼é€‰æ‹© -->
      <div class="modes">
        <label
          >æ¨¡å¼ï¼š
          <select id="mode">
            <option value="classic">ç»å…¸æ¨¡å¼</option>
            <option value="noborder">æ— è¾¹ç•Œæ¨¡å¼</option>
            <option value="timed">é™æ—¶æŒ‘æˆ˜</option>
          </select>
        </label>
      </div>

      <!-- æ’è¡Œæ¦œ -->
      <div class="leaderboard">
        <h3>ğŸ“œ æ’è¡Œæ¦œï¼ˆå‰5åï¼‰</h3>
        <ul id="rankList"></ul>
        <button id="clearRank">æ¸…é™¤è®°å½•</button>
      </div>

      <div class="instructions">ä½¿ç”¨é”®ç›˜ <b>â†‘ â†“ â† â†’</b> æ§åˆ¶è›‡æ–¹å‘</div>
    </div>

    <script>
      // ç”»å¸ƒ & å˜é‡
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const box = 20;
      let snake, food, direction, score, shield, timer;
      let game,
        speed = 150,
        mode = "classic";
      let highscore = localStorage.getItem("snakeHighScore") || 0;
      document.getElementById("highscore").textContent = highscore;

      // éŸ³ä¹/éŸ³æ•ˆ
      const eatSound = new Audio(
        "https://assets.mixkit.co/sfx/preview/mixkit-game-ball-tap-2073.mp3"
      );
      const dieSound = new Audio(
        "https://assets.mixkit.co/sfx/preview/mixkit-player-losing-or-failing-2042.mp3"
      );
      const bgm = new Audio(
        "https://www.bensound.com/bensound-music/bensound-littleidea.mp3"
      );
      bgm.loop = true;

      // åˆå§‹åŒ–æ¸¸æˆ
      function initGame() {
        snake = [{ x: 9 * box, y: 10 * box }];
        direction = null;
        score = 0;
        shield = false;
        food = spawnFood();
        clearInterval(game);
        game = setInterval(drawGame, speed);
        if (document.getElementById("bgmToggle").checked) bgm.play();
      }

      // ç”Ÿæˆé£Ÿç‰©/é“å…·
      function spawnFood() {
        // æ™®é€šé£Ÿç‰©ä¿æŒç©å®¶é€‰å®šæ ·å¼
        let type = "food";
        return {
          x: Math.floor(Math.random() * 20) * box,
          y: Math.floor(Math.random() * 20) * box,
          type:
            Math.random() < 0.1
              ? "star"
              : Math.random() < 0.15
              ? "speed"
              : Math.random() < 0.2
              ? "shield"
              : type,
          style: document.getElementById("foodStyle").value,
        };
      }

      // ç»˜åˆ¶æ¸¸æˆ
      function drawGame() {
        drawBackground();
        const snakeColor = document.getElementById("snakeColor").value;

        // ç”»è›‡ï¼ˆå…¨ä½“ç»Ÿä¸€é¢œè‰²ï¼‰
        for (let i = 0; i < snake.length; i++) {
          ctx.fillStyle = snakeColor;
          ctx.shadowColor = "#000";
          ctx.shadowBlur = 3;
          ctx.fillRect(snake[i].x, snake[i].y, box, box);
          ctx.strokeStyle = "#fff";
          ctx.strokeRect(snake[i].x, snake[i].y, box, box);
          ctx.shadowBlur = 0;
        }

        // ç”»é£Ÿç‰©/é“å…·
        if (food.type === "food") drawFood(food.x, food.y, food.style);
        if (food.type === "star") {
          ctx.fillStyle = "gold";
          ctx.beginPath();
          ctx.arc(food.x + 10, food.y + 10, 8, 0, Math.PI * 2);
          ctx.fill();
        }
        if (food.type === "speed") {
          ctx.fillStyle = "blue";
          ctx.fillRect(food.x, food.y, box, box);
        }
        if (food.type === "shield") {
          ctx.fillStyle = "purple";
          ctx.fillRect(food.x, food.y, box, box);
        }

        // ç§»åŠ¨è›‡
        let snakeX = snake[0].x,
          snakeY = snake[0].y;
        if (direction === "LEFT") snakeX -= box;
        if (direction === "UP") snakeY -= box;
        if (direction === "RIGHT") snakeX += box;
        if (direction === "DOWN") snakeY += box;

        // æ¨¡å¼ï¼šæ— è¾¹ç•Œ
        if (mode === "noborder") {
          if (snakeX < 0) snakeX = canvas.width - box;
          if (snakeY < 0) snakeY = canvas.height - box;
          if (snakeX >= canvas.width) snakeX = 0;
          if (snakeY >= canvas.height) snakeY = 0;
        }

        // åƒé£Ÿç‰©
        if (snakeX === food.x && snakeY === food.y) {
          if (document.getElementById("sfxToggle").checked) eatSound.play();
          if (food.type === "food") score++;
          if (food.type === "star") score += 10;
          if (food.type === "speed") {
            clearInterval(game);
            game = setInterval(drawGame, speed / 2);
            setTimeout(() => {
              clearInterval(game);
              game = setInterval(drawGame, speed);
            }, 3000);
          }
          if (food.type === "shield") shield = true;
          food = spawnFood();
        } else {
          snake.pop();
        }

        let newHead = { x: snakeX, y: snakeY };
        // æ’å¢™
        if (
          mode !== "noborder" &&
          (snakeX < 0 ||
            snakeY < 0 ||
            snakeX >= canvas.width ||
            snakeY >= canvas.height)
        ) {
          if (shield) {
            shield = false;
          } else return gameOver();
        }
        // æ’è‡ªå·±
        if (collision(newHead, snake)) {
          if (shield) {
            shield = false;
          } else return gameOver();
        }

        snake.unshift(newHead);
        document.getElementById("score").textContent = score;

        // é™æ—¶æ¨¡å¼
        if (mode === "timed") {
          if (!timer) timer = 60;
          if (score % 2 === 0) timer -= 0.05; // å€’è®¡æ—¶
          if (timer <= 0) return gameOver("æ—¶é—´åˆ°ï¼");
        }
      }

      // èƒŒæ™¯
      function drawBackground() {
        const theme = document.getElementById("theme").value;
        if (theme === "plain") {
          ctx.fillStyle = "#f5f5f5";
        }
        if (theme === "gradient") {
          let g = ctx.createLinearGradient(0, 0, 400, 400);
          g.addColorStop(0, "#74ebd5");
          g.addColorStop(1, "#9face6");
          ctx.fillStyle = g;
        }
        if (theme === "grass") {
          ctx.fillStyle = "#a8d08d";
        }
        if (theme === "pixel") {
          ctx.fillStyle = "#ddd";
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.fillStyle = "#bbb";
          for (let x = 0; x < 400; x += 20) {
            for (let y = 0; y < 400; y += 20) {
              ctx.fillRect(x, y, 19, 19);
            }
          }
          return;
        }
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }

      // é£Ÿç‰©æ ·å¼
      function drawFood(x, y, style) {
        if (style === "square") {
          ctx.fillStyle = "#ff5722";
          ctx.fillRect(x, y, box, box);
        }
        if (style === "apple" || style === "cherry" || style === "cookie") {
          ctx.font = "20px Arial";
          ctx.fillText(
            style === "apple" ? "ğŸ" : style === "cherry" ? "ğŸ’" : "ğŸª",
            x,
            y + 18
          );
        }
      }

      // ç¢°æ’æ£€æµ‹
      function collision(head, array) {
        for (let i = 0; i < array.length; i++) {
          if (head.x === array[i].x && head.y === array[i].y) {
            return true;
          }
        }
        return false;
      }

      // æ¸¸æˆç»“æŸ
      function gameOver(msg = "æ¸¸æˆç»“æŸï¼") {
        clearInterval(game);
        bgm.pause();
        if (document.getElementById("sfxToggle").checked) dieSound.play();
        alert(msg + " å¾—åˆ†ï¼š" + score);
        if (score > highscore) {
          localStorage.setItem("snakeHighScore", score);
        }
        saveRank(score);
        document.getElementById("highscore").textContent =
          localStorage.getItem("snakeHighScore") || 0;
      }

      // æ’è¡Œæ¦œ
      function saveRank(score) {
        let ranks = JSON.parse(localStorage.getItem("snakeRank") || "[]");
        let name = prompt("è¯·è¾“å…¥æ˜µç§°ï¼š", "ç©å®¶") || "åŒ¿å";
        ranks.push({ name, score, date: new Date().toLocaleDateString() });
        ranks.sort((a, b) => b.score - a.score);
        ranks = ranks.slice(0, 5);
        localStorage.setItem("snakeRank", JSON.stringify(ranks));
        renderRank();
      }
      function renderRank() {
        let ranks = JSON.parse(localStorage.getItem("snakeRank") || "[]");
        document.getElementById("rankList").innerHTML = ranks
          .map((r) => `<li>${r.name} - ${r.score}åˆ† (${r.date})</li>`)
          .join("");
      }
      renderRank();

      // æ§ä»¶äº‹ä»¶
      document.getElementById("startBtn").onclick = initGame;
      document.getElementById("pauseBtn").onclick = () => clearInterval(game);
      document.getElementById("resetBtn").onclick = initGame;
      document.getElementById("difficulty").onchange = function () {
        speed = this.value;
      };
      document.getElementById("speedRange").oninput = function () {
        speed = this.value;
        if (game) {
          clearInterval(game);
          game = setInterval(drawGame, speed);
        }
      };
      document.getElementById("theme").onchange = () => drawBackground();
      document.getElementById("mode").onchange = function () {
        mode = this.value;
      };
      document.getElementById("bgmToggle").onchange = function () {
        this.checked ? bgm.play() : bgm.pause();
      };
      document.getElementById("clearRank").onclick = function () {
        localStorage.removeItem("snakeRank");
        renderRank();
      };

      // æ–¹å‘é”®
      document.addEventListener("keydown", (e) => {
        if (e.key === "ArrowLeft" && direction !== "RIGHT") direction = "LEFT";
        else if (e.key === "ArrowUp" && direction !== "DOWN") direction = "UP";
        else if (e.key === "ArrowRight" && direction !== "LEFT")
          direction = "RIGHT";
        else if (e.key === "ArrowDown" && direction !== "UP")
          direction = "DOWN";
      });
    </script>
  </body>
</html>
